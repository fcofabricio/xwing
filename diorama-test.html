<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <script src="js/vendor/modernizr-2.8.3.min.js"></script>

        <style>
            /*! normalize.css v3.0.2 | MIT License | git.io/normalize */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}

            /*! HTML5 Boilerplate v4.3.0 | MIT License | http://h5bp.com/ */
            html {
                color: white;
                font-size: 1em;
                line-height: 1.4;
                background: black;
            }

            body {
                background: black;
            }

            ::-moz-selection {
                background: #b3d4fc;
                text-shadow: none;
            }

            ::selection {
                background: #b3d4fc;
                text-shadow: none;
            }

            hr {
                display: block;
                height: 1px;
                border: 0;
                border-top: 1px solid #ccc;
                margin: 1em 0;
                padding: 0;
            }

            audio,
            canvas,
            iframe,
            img,
            svg,
            video {
                vertical-align: middle;
            }

            fieldset {
                border: 0;
                margin: 0;
                padding: 0;
            }

            textarea {
                resize: vertical;
            }

            .browserupgrade {
                margin: 0.2em 0;
                background: #ccc;
                color: #000;
                padding: 0.2em 0;
            }

            /* ==========================================================================
               Helper classes
               ========================================================================== */

            .hidden {
                display: none !important;
                visibility: hidden;
            }

            .visuallyhidden {
                border: 0;
                clip: rect(0 0 0 0);
                height: 1px;
                margin: -1px;
                overflow: hidden;
                padding: 0;
                position: absolute;
                width: 1px;
            }

            .visuallyhidden.focusable:active,
            .visuallyhidden.focusable:focus {
                clip: auto;
                height: auto;
                margin: 0;
                overflow: visible;
                position: static;
                width: auto;
            }

            .invisible {
                visibility: hidden;
            }

            .clearfix:before,
            .clearfix:after {
                content: " ";
                display: table;
            }

            .clearfix:after {
                clear: both;
            }

            .clearfix {
                *zoom: 1;
            }

            /* ==========================================================================
               Base styling
               ========================================================================== */

            .diorama {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;

                /*background-image: url('../img/grid.png'), url('../img/stars.png');
                background-image: url('../img/stars.png');*/

                background: url('../img/backdrop-1.jpg') no-repeat;
                background-size: 100% 50%;
                background-position: center;
            }

            .diorama .stage {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                margin: auto;
                width: 1px;
                height: 1px;
            }

            .diorama .ship {
                position: absolute;
                /*background: rgba(255,0,0,0.2);*/
                -webkit-filter: drop-shadow(2px -4px 4px rgba(0,0,0,0.4));
                filter:         drop-shadow(2px -4px 4px rgba(0,0,0,0.4));
            }
        </style>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <div class="diorama">
            <div class="stage"></div>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>

        <script src="js/vendor/bin-packing/js/packer.js"></script>
        <script src="js/vendor/bin-packing/js/packer.growing.js"></script>

        <script>
            $(document).ready(function() {
                var $stage = $('.diorama .stage');
                var cell = {
                    w: 128,
                    h: 64
                };

                var ships = [
                    // REBELS

                    {
                        name: "X-Wing",
                        image: "rebel/xwing.png",
                        size: [255, 302],
                        offset: [128, 302],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "Y-Wing",
                        image: "rebel/ywing.png",
                        size: [215, 276],
                        offset: [110, 276],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "A-Wing",
                        image: "rebel/awing.png",
                        size: [213, 326],
                        offset: [108, 326],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "A-Wing (Ace)",
                        image: "rebel/awing-ace.png",
                        size: [213, 326],
                        offset: [108, 326],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "B-Wing",
                        image: "rebel/bwing.png",
                        size: [241, 326],
                        offset: [141, 326],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "B-Wing (Ace)",
                        image: "rebel/bwing-ace.png",
                        size: [241, 326],
                        offset: [141, 326],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "E-Wing",
                        image: "rebel/ewing.png",
                        size: [209, 269],
                        offset: [108, 269],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "E-Wing (Ace)",
                        image: "rebel/ewing-ace.png",
                        size: [210, 269],
                        offset: [110, 260],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "HWK-290",
                        image: "rebel/hwk290.png",
                        size: [228, 290],
                        offset: [114, 290],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "Z95",
                        image: "rebel/z95.png",
                        size: [209, 268],
                        offset: [104, 268],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "YT-2400",
                        image: "rebel/yt2400.png",
                        size: [388, 379],
                        offset: [194, 379],
                        w: 4,
                        h: 4,
                        p: 1  //padding, included in height
                    },
                    {
                        name: "YT-1300",
                        image: "rebel/yt1300.png",
                        size: [472, 389],
                        offset: [236, 389],
                        w: 4,
                        h: 4,
                        p: 1 //padding, included in height
                    },

                    // Epic Ships removed until issue with rectangular ships is fixed

                    // {
                    //     name: "Rebel Transport",
                    //     image: "rebel/transport.png",
                    //     size: [627, 531],
                    //     offset: [234, 531],
                    //     w: 8,
                    //     h: 4,
                    //     p: 1 //padding, included in height
                    // },
                    // {
                    //     name: "Tantive IV",
                    //     image: "rebel/tantive-iv.png",
                    //     size: [949, 697],
                    //     offset: [356, 697],
                    //     w: 11,
                    //     h: 4,
                    //     p: 1 //padding, included in height
                    // },


                    // IMPERIAL

                    {
                        name: "TIE Fighter",
                        image: "imperial/tie-fighter.png",
                        size: [211, 365],
                        offset: [100, 365],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Bomber",
                        image: "imperial/tie-bomber.png",
                        size: [211, 276],
                        offset: [100, 276],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Interceptor",
                        image: "imperial/tie-interceptor.png",
                        size: [211, 277],
                        offset: [100, 277],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Interceptor (Ace)",
                        image: "imperial/tie-interceptor-ace.png",
                        size: [211, 277],
                        offset: [100, 277],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Interceptor (Jax)",
                        image: "imperial/tie-interceptor-red.png",
                        size: [211, 277],
                        offset: [100, 277],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Advanced",
                        image: "imperial/tie-advanced.png",
                        size: [209, 294],
                        offset: [105, 294],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Advanced (New)",
                        image: "imperial/tie-advanced-repaint.png",
                        size: [210, 327],
                        offset: [102, 327],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Defender",
                        image: "imperial/tie-defender.png",
                        size: [219, 368],
                        offset: [102, 368],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "TIE Phantom",
                        image: "imperial/tie-phantom.png",
                        size: [216, 315],
                        offset: [102, 315],
                        w: 2.5,
                        h: 2.5,
                        p: 0.5
                    },
                    {
                        name: "Slave 1",
                        image: "imperial/slave-1.png",
                        size: [384, 435],
                        offset: [192, 435],
                        w: 4,
                        h: 4,
                        p: 1
                    },
                    {
                        name: "Lambda Shuttle",
                        image: "imperial/lambda-shuttle.png",
                        size: [407, 467],
                        offset: [192, 467],
                        w: 4,
                        h: 4,
                        p: 1
                    },
                    {
                        name: "Decimator",
                        image: "imperial/decimator.png",
                        size: [475, 398],
                        offset: [290, 398],
                        w: 4,
                        h: 4,
                        p: 1
                    },

                    // Epic Ships removed until issue with rectangular ships is fixed
                    // {
                    //     name: "Raider",
                    //     image: "imperial/raider.png",
                    //     size: [756, 617],
                    //     offset: [290, 398], //@todo
                    //     w: 8, //@todo
                    //     h: 4, //@todo
                    //     p: 1
                    // },

                    // SCUM

                ];

                var generateMap = function(drawnShipIndexes) {
                    var map        = [],
                        drawnShips = [],
                        packer     = new GrowingPacker();

                    // Pick ships from dataset by supplied indexes
                    drawnShipIndexes.forEach(function(shipId) {
                        drawnShips.push(jQuery.extend(true, {}, ships[shipId])); // Add clone of ship to array
                    });

                    // Sort by width
                    drawnShips.sort(function(a, b) { return (b.w > a.w); });

                    packer.fit(drawnShips);

                    return drawnShips;
                };

                var drawMap = function(map) {
                    var min = [9999999,9999999],
                        max = [0,0];

                    var shipDivs = [];

                    map.forEach(function(ship) {
                        var pos = ship.fit;

                        if(!pos) {
                            console.log('Ship does not fit', ship);
                            return;
                        }

                        var $div = $('<div>').addClass('ship'),
                            $img = $('<img>');

                        $img.attr('src', 'img/ships/'+ship.image);
                        $div.append($img);

                        var top  = 0,
                            left = 0;

                        ship.p = ship.p || 0;

                        left =  ((pos.x - pos.y) * (cell.w/2)) - ship.offset[0];
                        top = ((pos.x + pos.y) * (cell.h/2)) - (ship.offset[1] - ((ship.h - ship.p) * cell.h));

                        // Update min, max
                        if(left < min[0])
                            min[0] = left;

                        if(top < min[1])
                            min[1] = top;

                        if(left + ship.offset[0] > max[0])
                            max[0] = left + ship.size[0]; // Note: ship.offset[0] is not same as image width

                        if(top + ship.offset[1] > max[1])
                            max[1] = top + ship.size[1];

                        // Add to list
                        shipDivs.push({
                            $el: $div,
                            top: top,
                            left: left
                        });
                    });

                    // Now we have min positions we can place the ships correctly
                    shipDivs.forEach(function(ship) {
                        ship.$el.css('top', ship.top - min[1])
                                .css('left', ship.left - min[0]);

                        $stage.append(ship.$el);
                    });

                    $stage.width(max[0] - min[0]);
                    $stage.height(max[1] - min[1]);
                };

                var getRandomInt = function(min, max) {
                    return Math.floor(Math.random() * (max - min)) + min;
                };

                ////
                // Print Ship Data
                ships.forEach(function(ship, idx) {
                    console.log(idx, ship.name);
                });

                ////
                // Random List

                // var randomShipList = [];

                // for (var i = getRandomInt(1, ships.length) - 1; i >= 0; i--) {
                //     randomShipList.push(getRandomInt(0, ships.length));
                // };

                // drawMap(generateMap(randomShipList));

                ////
                // Worlds 2014 Lists

                var worlds2014Lists = [
                    [11,9,9,9,9],
                    [4,4,4,1],
                    [15,20,22],
                    [12,12,12,12,20],
                    [12,12,12,12,12,12,12],
                    [0,9,0,0]
                ];

                drawMap(generateMap(worlds2014Lists[getRandomInt(0, worlds2014Lists.length)]));
            });
        </script>
    </body>
</html>
